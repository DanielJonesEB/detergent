You are running non-interactively. Do not ask questions or wait for confirmation. If something is unclear, make your best judgement and proceed.

# Concern: docs

## Prompt

If you use beads, act on the work immediately and do not exit until those beads have been resolved. Ensure README is up to date with latest features. Don't change any other files and do not push.

## New commits to review

### Commit f4283554
Message: [DRY] Consolidate JSON writing with trailing newline

Reduces duplication by creating fileutil.WriteJSON helper that
combines the json.MarshalIndent + append newline + os.WriteFile
pattern used in 2 locations:

- internal/engine/engine.go:writePermissions - Writing Claude settings
- internal/cli/init.go:initStatusline - Writing statusline config

Both call sites now use fileutil.WriteJSON instead of repeating
the 6-line marshal/append/write pattern.

Also removes unused encoding/json import from engine/engine.go.

Co-Authored-By: Claude Sonnet 4.5 <noreply@anthropic.com>

```diff
diff --git a/internal/cli/init.go b/internal/cli/init.go
index 6d22f68..52f2b9f 100644
--- a/internal/cli/init.go
+++ b/internal/cli/init.go
@@ -125,10 +125,8 @@ func initStatusline(repoDir string) error {
 		"type":    "command",
 	}
 
-	out, err := json.MarshalIndent(settings, "", "  ")
-	if err != nil {
-		return fmt.Errorf("marshaling settings: %w", err)
+	if err := fileutil.WriteJSON(settingsPath, settings); err != nil {
+		return fmt.Errorf("writing settings: %w", err)
 	}
-
-	return os.WriteFile(settingsPath, append(out, '\n'), 0o644)
+	return nil
 }
diff --git a/internal/engine/engine.go b/internal/engine/engine.go
index 8c05e35..9e93125 100644
--- a/internal/engine/engine.go
+++ b/internal/engine/engine.go
@@ -1,7 +1,6 @@
 package engine
 
 import (
-	"encoding/json"
 	"errors"
 	"fmt"
 	"io"
@@ -507,12 +506,7 @@ func writePermissions(worktreeDir string, perms *config.Permissions) error {
 	settings := map[string]interface{}{
 		"permissions": perms,
 	}
-	data, err := json.MarshalIndent(settings, "", "  ")
-	if err != nil {
-		return err
-	}
-
-	return os.WriteFile(fileutil.ClaudeSubpath(worktreeDir, "settings.json"), append(data, '\n'), 0644)
+	return fileutil.WriteJSON(fileutil.ClaudeSubpath(worktreeDir, "settings.json"), settings)
 }
 
 func commitChanges(worktreeDir string, concern config.Concern, triggeredBy string) (bool, error) {
diff --git a/internal/fileutil/fileutil.go b/internal/fileutil/fileutil.go
index fbc89e1..2b526b5 100644
--- a/internal/fileutil/fileutil.go
+++ b/internal/fileutil/fileutil.go
@@ -1,6 +1,7 @@
 package fileutil
 
 import (
+	"encoding/json"
 	"fmt"
 	"os"
 )
@@ -14,3 +15,12 @@ func EnsureDir(path string) error {
 func LogError(format string, args ...interface{}) {
 	fmt.Fprintf(os.Stderr, format+"\n", args...)
 }
+
+// WriteJSON marshals data to indented JSON and writes it to path with a trailing newline.
+func WriteJSON(path string, data interface{}) error {
+	bytes, err := json.MarshalIndent(data, "", "  ")
+	if err != nil {
+		return err
+	}
+	return os.WriteFile(path, append(bytes, '\n'), 0644)
+}
```

### Commit 8bfed7cf
Message: Remove unused logConcernError wrapper function

The logConcernError function was a thin wrapper around fileutil.LogError
that only formatted an error message. Inlined its two call sites to use
fileutil.LogError directly, eliminating the unnecessary indirection.

Co-Authored-By: Claude Sonnet 4.5 <noreply@anthropic.com>

```diff
diff --git a/internal/engine/engine.go b/internal/engine/engine.go
index bbc1347..8c05e35 100644
--- a/internal/engine/engine.go
+++ b/internal/engine/engine.go
@@ -19,11 +19,6 @@ import (
 	gitops "github.com/re-cinq/detergent/internal/git"
 )
 
-// logConcernError writes a concern-specific error message to stderr.
-func logConcernError(concernName string, err error) {
-	fileutil.LogError("concern %s failed: %s", concernName, err)
-}
-
 // LogManager manages per-concern log files for agent output.
 type LogManager struct {
 	mu    sync.Mutex
@@ -117,7 +112,7 @@ func RunOnceWithLogs(cfg *config.Config, repoDir string, logMgr *LogManager) err
 				continue
 			}
 			if err := processConcern(cfg, repo, repoDir, c, logMgr); err != nil {
-				logConcernError(c.Name, err)
+				fileutil.LogError("concern %s failed: %s", c.Name, err)
 				failed.set(c.Name)
 			}
 		} else {
@@ -132,7 +127,7 @@ func RunOnceWithLogs(cfg *config.Config, repoDir string, logMgr *LogManager) err
 				go func(concern config.Concern) {
 					defer wg.Done()
 					if err := processConcern(cfg, repo, repoDir, concern, logMgr); err != nil {
-						logConcernError(concern.Name, err)
+						fileutil.LogError("concern %s failed: %s", concern.Name, err)
 						failed.set(concern.Name)
 					}
 				}(c)
```

### Commit 291e64c6
Message: Merge additional DRY refactoring from detergent/dry

```diff
diff --git a/internal/cli/helpers.go b/internal/cli/helpers.go
index 5e33aa8..23d2958 100644
--- a/internal/cli/helpers.go
+++ b/internal/cli/helpers.go
@@ -15,14 +15,14 @@ import (
 func loadAndValidateConfig(path string) (*config.Config, error) {
 	cfg, err := config.Load(path)
 	if err != nil {
-		logError("Error: %s", err)
+		fileutil.LogError("Error: %s", err)
 		return nil, err
 	}
 
 	errs := config.Validate(cfg)
 	if len(errs) > 0 {
 		for _, e := range errs {
-			logError("Error: %s", e)
+			fileutil.LogError("Error: %s", e)
 		}
 		return nil, fmt.Errorf("%d validation error(s)", len(errs))
 	}
@@ -96,13 +96,3 @@ func setupSignalHandler() chan os.Signal {
 	signal.Notify(sigCh, syscall.SIGINT, syscall.SIGTERM)
 	return sigCh
 }
-
-// logError writes an error message to stderr.
-func logError(format string, args ...interface{}) {
-	fmt.Fprintf(os.Stderr, format+"\n", args...)
-}
-
-// ensureDir creates a directory and all parent directories with 0755 permissions.
-func ensureDir(path string) error {
-	return fileutil.EnsureDir(path)
-}
diff --git a/internal/cli/init.go b/internal/cli/init.go
index dc24fae..6d22f68 100644
--- a/internal/cli/init.go
+++ b/internal/cli/init.go
@@ -8,6 +8,7 @@ import (
 	"path/filepath"
 
 	"github.com/re-cinq/detergent/internal/assets"
+	"github.com/re-cinq/detergent/internal/fileutil"
 	"github.com/spf13/cobra"
 )
 
@@ -69,10 +70,10 @@ func initSkills(repoDir string) ([]string, error) {
 		}
 
 		// Target path: .claude/<path> (skills/detergent-rebase/SKILL.md -> .claude/skills/detergent-rebase/SKILL.md)
-		target := filepath.Join(repoDir, ".claude", path)
+		target := fileutil.ClaudeSubpath(repoDir, path)
 
 		if d.IsDir() {
-			return ensureDir(target)
+			return fileutil.EnsureDir(target)
 		}
 
 		data, err := assets.Skills.ReadFile(path)
@@ -103,10 +104,10 @@ func initStatusline(repoDir string) error {
 		detergentBin = "detergent"
 	}
 
-	settingsPath := filepath.Join(repoDir, ".claude", "settings.local.json")
+	settingsPath := fileutil.ClaudeSubpath(repoDir, "settings.local.json")
 
 	// Ensure .claude/ exists
-	if err := ensureDir(filepath.Dir(settingsPath)); err != nil {
+	if err := fileutil.EnsureDir(fileutil.ClaudeDir(repoDir)); err != nil {
 		return err
 	}
 
diff --git a/internal/cli/run.go b/internal/cli/run.go
index debbbb1..800b35d 100644
--- a/internal/cli/run.go
+++ b/internal/cli/run.go
@@ -7,6 +7,7 @@ import (
 
 	"github.com/re-cinq/detergent/internal/config"
 	"github.com/re-cinq/detergent/internal/engine"
+	"github.com/re-cinq/detergent/internal/fileutil"
 	"github.com/spf13/cobra"
 )
 
@@ -58,7 +59,7 @@ func runDaemon(cfg *config.Config, repoDir string) error {
 
 	// Run immediately on startup
 	if err := engine.RunOnceWithLogs(cfg, repoDir, logMgr); err != nil {
-		logError("poll error: %s", err)
+		fileutil.LogError("poll error: %s", err)
 	}
 
 	for {
@@ -72,7 +73,7 @@ func runDaemon(cfg *config.Config, repoDir string) error {
 		case <-ticker.C:
 			cfg = reloadConfig(configPath, cfg, ticker)
 			if err := engine.RunOnceWithLogs(cfg, repoDir, logMgr); err != nil {
-				logError("poll error: %s", err)
+				fileutil.LogError("poll error: %s", err)
 			}
 		}
 	}
@@ -84,11 +85,11 @@ func runDaemon(cfg *config.Config, repoDir string) error {
 func reloadConfig(path string, prev *config.Config, ticker *time.Ticker) *config.Config {
 	newCfg, err := config.Load(path)
 	if err != nil {
-		logError("config reload: %s (keeping previous config)", err)
+		fileutil.LogError("config reload: %s (keeping previous config)", err)
 		return prev
 	}
 	if errs := config.Validate(newCfg); len(errs) > 0 {
-		logError("config reload: invalid (%s) (keeping previous config)", errs[0])
+		fileutil.LogError("config reload: invalid (%s) (keeping previous config)", errs[0])
 		return prev
 	}
 
diff --git a/internal/cli/status.go b/internal/cli/status.go
index 107ba79..b00e982 100644
--- a/internal/cli/status.go
+++ b/internal/cli/status.go
@@ -11,6 +11,7 @@ import (
 
 	"github.com/re-cinq/detergent/internal/config"
 	"github.com/re-cinq/detergent/internal/engine"
+	"github.com/re-cinq/detergent/internal/fileutil"
 	gitops "github.com/re-cinq/detergent/internal/git"
 	"github.com/spf13/cobra"
 )
@@ -58,7 +59,7 @@ func followStatus(cfg *config.Config, repoDir string) error {
 	for {
 		var buf bytes.Buffer
 		if err := renderStatus(&buf, cfg, repoDir, true); err != nil {
-			logError("\nerror: %s", err)
+			fileutil.LogError("\nerror: %s", err)
 		}
 		output := buf.String()
 
diff --git a/internal/engine/engine.go b/internal/engine/engine.go
index 06847a9..bbc1347 100644
--- a/internal/engine/engine.go
+++ b/internal/engine/engine.go
@@ -19,14 +19,9 @@ import (
 	gitops "github.com/re-cinq/detergent/internal/git"
 )
 
-// logError writes an error message to stderr.
-func logError(format string, args ...interface{}) {
-	fmt.Fprintf(os.Stderr, format+"\n", args...)
-}
-
 // logConcernError writes a concern-specific error message to stderr.
 func logConcernError(concernName string, err error) {
-	fmt.Fprintf(os.Stderr, "concern %s failed: %s\n", concernName, err)
+	fileutil.LogError("concern %s failed: %s", concernName, err)
 }
 
 // LogManager manages per-concern log files for agent output.
@@ -368,7 +363,7 @@ func writeSkippedStatus(repoDir, concernName, errorMsg string, pid int) {
 
 // skipUpstreamFailed logs and marks a concern as skipped due to upstream failure.
 func skipUpstreamFailed(repoDir, concernName string, pid int) {
-	logError("skipping %s: upstream concern failed", concernName)
+	fileutil.LogError("skipping %s: upstream concern failed", concernName)
 	writeSkippedStatus(repoDir, concernName, "upstream concern failed", pid)
 }
 
@@ -509,7 +504,7 @@ func invokeAgent(cfg *config.Config, worktreeDir, context string, output io.Writ
 // writePermissions writes a .claude/settings.json file in the worktree
 // with the configured permissions, so Claude Code agents get pre-approved tools.
 func writePermissions(worktreeDir string, perms *config.Permissions) error {
-	claudeDir := filepath.Join(worktreeDir, ".claude")
+	claudeDir := fileutil.ClaudeDir(worktreeDir)
 	if err := fileutil.EnsureDir(claudeDir); err != nil {
 		return err
 	}
@@ -522,7 +517,7 @@ func writePermissions(worktreeDir string, perms *config.Permissions) error {
 		return err
 	}
 
-	return os.WriteFile(filepath.Join(claudeDir, "settings.json"), append(data, '\n'), 0644)
+	return os.WriteFile(fileutil.ClaudeSubpath(worktreeDir, "settings.json"), append(data, '\n'), 0644)
 }
 
 func commitChanges(worktreeDir string, concern config.Concern, triggeredBy string) (bool, error) {
diff --git a/internal/engine/state.go b/internal/engine/state.go
index 2cc7c04..b7d59fe 100644
--- a/internal/engine/state.go
+++ b/internal/engine/state.go
@@ -28,14 +28,9 @@ const (
 	ResultModified = "modified"
 )
 
-// detergentSubdir builds a path to a subdirectory within .detergent.
-func detergentSubdir(repoDir, subdir string) string {
-	return filepath.Join(repoDir, ".detergent", subdir)
-}
-
 // stateDir returns the state directory path for a repo.
 func stateDir(repoDir string) string {
-	return detergentSubdir(repoDir, "state")
+	return fileutil.DetergentSubdir(repoDir, "state")
 }
 
 // LastSeen returns the last-seen commit hash for a concern, or "" if none.
@@ -65,7 +60,7 @@ type ConcernStatus struct {
 
 // statusDir returns the status directory path for a repo.
 func statusDir(repoDir string) string {
-	return detergentSubdir(repoDir, "status")
+	return fileutil.DetergentSubdir(repoDir, "status")
 }
 
 // WriteStatus writes a concern's status to its JSON status file.
diff --git a/internal/fileutil/fileutil.go b/internal/fileutil/fileutil.go
index ce182a2..fbc89e1 100644
--- a/internal/fileutil/fileutil.go
+++ b/internal/fileutil/fileutil.go
@@ -1,8 +1,16 @@
 package fileutil
 
-import "os"
+import (
+	"fmt"
+	"os"
+)
 
 // EnsureDir creates a directory and all parent directories with 0755 permissions.
 func EnsureDir(path string) error {
 	return os.MkdirAll(path, 0755)
 }
+
+// LogError writes an error message to stderr.
+func LogError(format string, args ...interface{}) {
+	fmt.Fprintf(os.Stderr, format+"\n", args...)
+}
diff --git a/internal/fileutil/paths.go b/internal/fileutil/paths.go
new file mode 100644
index 0000000..728ed0b
--- /dev/null
+++ b/internal/fileutil/paths.go
@@ -0,0 +1,18 @@
+package fileutil
+
+import "path/filepath"
+
+// DetergentSubdir builds a path to a subdirectory within .detergent.
+func DetergentSubdir(repoDir, subdir string) string {
+	return filepath.Join(repoDir, ".detergent", subdir)
+}
+
+// ClaudeDir returns the .claude directory path for a repository.
+func ClaudeDir(repoDir string) string {
+	return filepath.Join(repoDir, ".claude")
+}
+
+// ClaudeSubpath returns a path within the .claude directory.
+func ClaudeSubpath(repoDir, subpath string) string {
+	return filepath.Join(repoDir, ".claude", subpath)
+}
diff --git a/internal/git/git.go b/internal/git/git.go
index 2d7fb0b..71edad5 100644
--- a/internal/git/git.go
+++ b/internal/git/git.go
@@ -5,6 +5,8 @@ import (
 	"os/exec"
 	"path/filepath"
 	"strings"
+
+	"github.com/re-cinq/detergent/internal/fileutil"
 )
 
 // Repo wraps git operations for a repository.
@@ -100,7 +102,7 @@ func (r *Repo) EnsureIdentity() {
 
 // WorktreePath returns the expected worktree path for a concern.
 func WorktreePath(repoDir, branchPrefix, concernName string) string {
-	return filepath.Join(repoDir, ".detergent", "worktrees", branchPrefix+concernName)
+	return fileutil.DetergentSubdir(repoDir, filepath.Join("worktrees", branchPrefix+concernName))
 }
 
 // HasChanges checks if there are any uncommitted changes in the worktree.
```

### Commit 06a0e2aa
Message: Clear stale active statuses on daemon startup

When the daemon is killed mid-processing, status files are left in
active states (agent_running, etc.). On restart, these are now reset
to failed at the start of each processing cycle, since no concern
should legitimately be active at that point.

Co-Authored-By: Claude Opus 4.6 <noreply@anthropic.com>

```diff
diff --git a/internal/engine/engine.go b/internal/engine/engine.go
index 5948e0c..06847a9 100644
--- a/internal/engine/engine.go
+++ b/internal/engine/engine.go
@@ -100,6 +100,13 @@ func RunOnce(cfg *config.Config, repoDir string) error {
 // RunOnceWithLogs processes each concern once using the provided LogManager.
 // The LogManager is not closed; the caller is responsible for closing it.
 func RunOnceWithLogs(cfg *config.Config, repoDir string, logMgr *LogManager) error {
+	// Clear any stale active statuses from a previous interrupted run.
+	concernNames := make([]string, len(cfg.Concerns))
+	for i, c := range cfg.Concerns {
+		concernNames[i] = c.Name
+	}
+	ResetActiveStatuses(repoDir, concernNames)
+
 	repo := gitops.NewRepo(repoDir)
 	repo.EnsureIdentity()
 
diff --git a/internal/engine/state.go b/internal/engine/state.go
index 2d02cb7..2cc7c04 100644
--- a/internal/engine/state.go
+++ b/internal/engine/state.go
@@ -125,6 +125,30 @@ func IsProcessAlive(pid int) bool {
 	return err == nil
 }
 
+// ResetActiveStatuses resets any concern status that is in an active state
+// (change_detected, agent_running, committing) back to idle. This should be
+// called at the start of each processing cycle â€” any active status at that
+// point is stale from a previous run that was interrupted (e.g., daemon killed).
+func ResetActiveStatuses(repoDir string, concernNames []string) {
+	pid := os.Getpid()
+	for _, name := range concernNames {
+		status, err := ReadStatus(repoDir, name)
+		if err != nil || status == nil {
+			continue
+		}
+		if !IsActiveState(status.State) {
+			continue
+		}
+		_ = WriteStatus(repoDir, name, &ConcernStatus{
+			State:      StateFailed,
+			Error:      fmt.Sprintf("stale %s state cleared on startup (previous process interrupted)", status.State),
+			LastSeen:   status.LastSeen,
+			LastResult: status.LastResult,
+			PID:        pid,
+		})
+	}
+}
+
 // SetLastSeen records the last-seen commit hash for a concern.
 func SetLastSeen(repoDir, concernName, hash string) error {
 	dir := stateDir(repoDir)
```

