You are running non-interactively. Do not ask questions or wait for confirmation. If something is unclear, make your best judgement and proceed.

# Concern: docs

## Prompt

If you use beads, act on the work immediately and do not exit until those beads have been resolved. Ensure README is up to date with latest features. Don't change any other files and do not push.

## New commits to review

### Commit ea9a0908
Message: [DRY] Consolidate logging and path utilities

Reduces duplication by centralizing common utilities:

1. **Consolidated logging** - Moved duplicate logError functions from cli/helpers.go
   and engine/engine.go into fileutil.LogError. All 8 call sites now use the
   shared implementation.

2. **Centralized path construction** - Created fileutil/paths.go with helpers:
   - DetergentSubdir: Build paths within .detergent/ (state/, status/, worktrees/)
   - ClaudeDir: Get .claude directory path
   - ClaudeSubpath: Build paths within .claude/

   Replaced 10+ hardcoded filepath.Join(repoDir, ".detergent", ...) and
   filepath.Join(worktreeDir, ".claude", ...) patterns with centralized helpers.

3. **Removed redundant wrapper** - Deleted cli/helpers.go:ensureDir which was
   just calling fileutil.EnsureDir. All call sites updated to use fileutil directly.

Changes:
- fileutil: Added LogError function and paths.go with path helpers
- cli: Updated 8 files to use fileutil.LogError, removed duplicate logError/ensureDir
- engine: Replaced logError calls and manual path construction with fileutil helpers
- git: Updated WorktreePath to use DetergentSubdir helper
- state: Removed local detergentSubdir, use fileutil.DetergentSubdir

All 82 acceptance tests pass. No functional changes, purely refactoring.

Triggered-By: f981564b

Co-Authored-By: Claude Sonnet 4.5 <noreply@anthropic.com>

```diff
diff --git a/internal/cli/helpers.go b/internal/cli/helpers.go
index 5e33aa8..23d2958 100644
--- a/internal/cli/helpers.go
+++ b/internal/cli/helpers.go
@@ -15,14 +15,14 @@ import (
 func loadAndValidateConfig(path string) (*config.Config, error) {
 	cfg, err := config.Load(path)
 	if err != nil {
-		logError("Error: %s", err)
+		fileutil.LogError("Error: %s", err)
 		return nil, err
 	}
 
 	errs := config.Validate(cfg)
 	if len(errs) > 0 {
 		for _, e := range errs {
-			logError("Error: %s", e)
+			fileutil.LogError("Error: %s", e)
 		}
 		return nil, fmt.Errorf("%d validation error(s)", len(errs))
 	}
@@ -96,13 +96,3 @@ func setupSignalHandler() chan os.Signal {
 	signal.Notify(sigCh, syscall.SIGINT, syscall.SIGTERM)
 	return sigCh
 }
-
-// logError writes an error message to stderr.
-func logError(format string, args ...interface{}) {
-	fmt.Fprintf(os.Stderr, format+"\n", args...)
-}
-
-// ensureDir creates a directory and all parent directories with 0755 permissions.
-func ensureDir(path string) error {
-	return fileutil.EnsureDir(path)
-}
diff --git a/internal/cli/init.go b/internal/cli/init.go
index dc24fae..6d22f68 100644
--- a/internal/cli/init.go
+++ b/internal/cli/init.go
@@ -8,6 +8,7 @@ import (
 	"path/filepath"
 
 	"github.com/re-cinq/detergent/internal/assets"
+	"github.com/re-cinq/detergent/internal/fileutil"
 	"github.com/spf13/cobra"
 )
 
@@ -69,10 +70,10 @@ func initSkills(repoDir string) ([]string, error) {
 		}
 
 		// Target path: .claude/<path> (skills/detergent-rebase/SKILL.md -> .claude/skills/detergent-rebase/SKILL.md)
-		target := filepath.Join(repoDir, ".claude", path)
+		target := fileutil.ClaudeSubpath(repoDir, path)
 
 		if d.IsDir() {
-			return ensureDir(target)
+			return fileutil.EnsureDir(target)
 		}
 
 		data, err := assets.Skills.ReadFile(path)
@@ -103,10 +104,10 @@ func initStatusline(repoDir string) error {
 		detergentBin = "detergent"
 	}
 
-	settingsPath := filepath.Join(repoDir, ".claude", "settings.local.json")
+	settingsPath := fileutil.ClaudeSubpath(repoDir, "settings.local.json")
 
 	// Ensure .claude/ exists
-	if err := ensureDir(filepath.Dir(settingsPath)); err != nil {
+	if err := fileutil.EnsureDir(fileutil.ClaudeDir(repoDir)); err != nil {
 		return err
 	}
 
diff --git a/internal/cli/run.go b/internal/cli/run.go
index debbbb1..800b35d 100644
--- a/internal/cli/run.go
+++ b/internal/cli/run.go
@@ -7,6 +7,7 @@ import (
 
 	"github.com/re-cinq/detergent/internal/config"
 	"github.com/re-cinq/detergent/internal/engine"
+	"github.com/re-cinq/detergent/internal/fileutil"
 	"github.com/spf13/cobra"
 )
 
@@ -58,7 +59,7 @@ func runDaemon(cfg *config.Config, repoDir string) error {
 
 	// Run immediately on startup
 	if err := engine.RunOnceWithLogs(cfg, repoDir, logMgr); err != nil {
-		logError("poll error: %s", err)
+		fileutil.LogError("poll error: %s", err)
 	}
 
 	for {
@@ -72,7 +73,7 @@ func runDaemon(cfg *config.Config, repoDir string) error {
 		case <-ticker.C:
 			cfg = reloadConfig(configPath, cfg, ticker)
 			if err := engine.RunOnceWithLogs(cfg, repoDir, logMgr); err != nil {
-				logError("poll error: %s", err)
+				fileutil.LogError("poll error: %s", err)
 			}
 		}
 	}
@@ -84,11 +85,11 @@ func runDaemon(cfg *config.Config, repoDir string) error {
 func reloadConfig(path string, prev *config.Config, ticker *time.Ticker) *config.Config {
 	newCfg, err := config.Load(path)
 	if err != nil {
-		logError("config reload: %s (keeping previous config)", err)
+		fileutil.LogError("config reload: %s (keeping previous config)", err)
 		return prev
 	}
 	if errs := config.Validate(newCfg); len(errs) > 0 {
-		logError("config reload: invalid (%s) (keeping previous config)", errs[0])
+		fileutil.LogError("config reload: invalid (%s) (keeping previous config)", errs[0])
 		return prev
 	}
 
diff --git a/internal/cli/status.go b/internal/cli/status.go
index 107ba79..b00e982 100644
--- a/internal/cli/status.go
+++ b/internal/cli/status.go
@@ -11,6 +11,7 @@ import (
 
 	"github.com/re-cinq/detergent/internal/config"
 	"github.com/re-cinq/detergent/internal/engine"
+	"github.com/re-cinq/detergent/internal/fileutil"
 	gitops "github.com/re-cinq/detergent/internal/git"
 	"github.com/spf13/cobra"
 )
@@ -58,7 +59,7 @@ func followStatus(cfg *config.Config, repoDir string) error {
 	for {
 		var buf bytes.Buffer
 		if err := renderStatus(&buf, cfg, repoDir, true); err != nil {
-			logError("\nerror: %s", err)
+			fileutil.LogError("\nerror: %s", err)
 		}
 		output := buf.String()
 
diff --git a/internal/engine/engine.go b/internal/engine/engine.go
index 5948e0c..92af192 100644
--- a/internal/engine/engine.go
+++ b/internal/engine/engine.go
@@ -19,14 +19,9 @@ import (
 	gitops "github.com/re-cinq/detergent/internal/git"
 )
 
-// logError writes an error message to stderr.
-func logError(format string, args ...interface{}) {
-	fmt.Fprintf(os.Stderr, format+"\n", args...)
-}
-
 // logConcernError writes a concern-specific error message to stderr.
 func logConcernError(concernName string, err error) {
-	fmt.Fprintf(os.Stderr, "concern %s failed: %s\n", concernName, err)
+	fileutil.LogError("concern %s failed: %s", concernName, err)
 }
 
 // LogManager manages per-concern log files for agent output.
@@ -361,7 +356,7 @@ func writeSkippedStatus(repoDir, concernName, errorMsg string, pid int) {
 
 // skipUpstreamFailed logs and marks a concern as skipped due to upstream failure.
 func skipUpstreamFailed(repoDir, concernName string, pid int) {
-	logError("skipping %s: upstream concern failed", concernName)
+	fileutil.LogError("skipping %s: upstream concern failed", concernName)
 	writeSkippedStatus(repoDir, concernName, "upstream concern failed", pid)
 }
 
@@ -502,7 +497,7 @@ func invokeAgent(cfg *config.Config, worktreeDir, context string, output io.Writ
 // writePermissions writes a .claude/settings.json file in the worktree
 // with the configured permissions, so Claude Code agents get pre-approved tools.
 func writePermissions(worktreeDir string, perms *config.Permissions) error {
-	claudeDir := filepath.Join(worktreeDir, ".claude")
+	claudeDir := fileutil.ClaudeDir(worktreeDir)
 	if err := fileutil.EnsureDir(claudeDir); err != nil {
 		return err
 	}
@@ -515,7 +510,7 @@ func writePermissions(worktreeDir string, perms *config.Permissions) error {
 		return err
 	}
 
-	return os.WriteFile(filepath.Join(claudeDir, "settings.json"), append(data, '\n'), 0644)
+	return os.WriteFile(fileutil.ClaudeSubpath(worktreeDir, "settings.json"), append(data, '\n'), 0644)
 }
 
 func commitChanges(worktreeDir string, concern config.Concern, triggeredBy string) (bool, error) {
diff --git a/internal/engine/state.go b/internal/engine/state.go
index 2d02cb7..002f543 100644
--- a/internal/engine/state.go
+++ b/internal/engine/state.go
@@ -28,14 +28,9 @@ const (
 	ResultModified = "modified"
 )
 
-// detergentSubdir builds a path to a subdirectory within .detergent.
-func detergentSubdir(repoDir, subdir string) string {
-	return filepath.Join(repoDir, ".detergent", subdir)
-}
-
 // stateDir returns the state directory path for a repo.
 func stateDir(repoDir string) string {
-	return detergentSubdir(repoDir, "state")
+	return fileutil.DetergentSubdir(repoDir, "state")
 }
 
 // LastSeen returns the last-seen commit hash for a concern, or "" if none.
@@ -65,7 +60,7 @@ type ConcernStatus struct {
 
 // statusDir returns the status directory path for a repo.
 func statusDir(repoDir string) string {
-	return detergentSubdir(repoDir, "status")
+	return fileutil.DetergentSubdir(repoDir, "status")
 }
 
 // WriteStatus writes a concern's status to its JSON status file.
diff --git a/internal/fileutil/fileutil.go b/internal/fileutil/fileutil.go
index ce182a2..fbc89e1 100644
--- a/internal/fileutil/fileutil.go
+++ b/internal/fileutil/fileutil.go
@@ -1,8 +1,16 @@
 package fileutil
 
-import "os"
+import (
+	"fmt"
+	"os"
+)
 
 // EnsureDir creates a directory and all parent directories with 0755 permissions.
 func EnsureDir(path string) error {
 	return os.MkdirAll(path, 0755)
 }
+
+// LogError writes an error message to stderr.
+func LogError(format string, args ...interface{}) {
+	fmt.Fprintf(os.Stderr, format+"\n", args...)
+}
diff --git a/internal/fileutil/paths.go b/internal/fileutil/paths.go
new file mode 100644
index 0000000..728ed0b
--- /dev/null
+++ b/internal/fileutil/paths.go
@@ -0,0 +1,18 @@
+package fileutil
+
+import "path/filepath"
+
+// DetergentSubdir builds a path to a subdirectory within .detergent.
+func DetergentSubdir(repoDir, subdir string) string {
+	return filepath.Join(repoDir, ".detergent", subdir)
+}
+
+// ClaudeDir returns the .claude directory path for a repository.
+func ClaudeDir(repoDir string) string {
+	return filepath.Join(repoDir, ".claude")
+}
+
+// ClaudeSubpath returns a path within the .claude directory.
+func ClaudeSubpath(repoDir, subpath string) string {
+	return filepath.Join(repoDir, ".claude", subpath)
+}
diff --git a/internal/git/git.go b/internal/git/git.go
index 2d7fb0b..71edad5 100644
--- a/internal/git/git.go
+++ b/internal/git/git.go
@@ -5,6 +5,8 @@ import (
 	"os/exec"
 	"path/filepath"
 	"strings"
+
+	"github.com/re-cinq/detergent/internal/fileutil"
 )
 
 // Repo wraps git operations for a repository.
@@ -100,7 +102,7 @@ func (r *Repo) EnsureIdentity() {
 
 // WorktreePath returns the expected worktree path for a concern.
 func WorktreePath(repoDir, branchPrefix, concernName string) string {
-	return filepath.Join(repoDir, ".detergent", "worktrees", branchPrefix+concernName)
+	return fileutil.DetergentSubdir(repoDir, filepath.Join("worktrees", branchPrefix+concernName))
 }
 
 // HasChanges checks if there are any uncommitted changes in the worktree.
```

### Commit f981564b
Message: Merge DRY refactoring from detergent/dry

```diff
diff --git a/internal/cli/helpers.go b/internal/cli/helpers.go
index 0be5e7b..5e33aa8 100644
--- a/internal/cli/helpers.go
+++ b/internal/cli/helpers.go
@@ -8,6 +8,7 @@ import (
 	"syscall"
 
 	"github.com/re-cinq/detergent/internal/config"
+	"github.com/re-cinq/detergent/internal/fileutil"
 )
 
 // loadAndValidateConfig loads a config file and validates it, printing errors to stderr.
@@ -21,7 +22,7 @@ func loadAndValidateConfig(path string) (*config.Config, error) {
 	errs := config.Validate(cfg)
 	if len(errs) > 0 {
 		for _, e := range errs {
-			fmt.Fprintf(os.Stderr, "Error: %s\n", e)
+			logError("Error: %s", e)
 		}
 		return nil, fmt.Errorf("%d validation error(s)", len(errs))
 	}
@@ -103,5 +104,5 @@ func logError(format string, args ...interface{}) {
 
 // ensureDir creates a directory and all parent directories with 0755 permissions.
 func ensureDir(path string) error {
-	return os.MkdirAll(path, 0755)
+	return fileutil.EnsureDir(path)
 }
diff --git a/internal/engine/engine.go b/internal/engine/engine.go
index 3c3f61b..5948e0c 100644
--- a/internal/engine/engine.go
+++ b/internal/engine/engine.go
@@ -15,6 +15,7 @@ import (
 
 	"github.com/creack/pty"
 	"github.com/re-cinq/detergent/internal/config"
+	"github.com/re-cinq/detergent/internal/fileutil"
 	gitops "github.com/re-cinq/detergent/internal/git"
 )
 
@@ -129,7 +130,7 @@ func RunOnceWithLogs(cfg *config.Config, repoDir string, logMgr *LogManager) err
 				go func(concern config.Concern) {
 					defer wg.Done()
 					if err := processConcern(cfg, repo, repoDir, concern, logMgr); err != nil {
-						fmt.Fprintf(os.Stderr, "concern %s failed: %s\n", concern.Name, err)
+						logConcernError(concern.Name, err)
 						failed.set(concern.Name)
 					}
 				}(c)
@@ -157,6 +158,23 @@ func (f *failedSet) has(name string) bool {
 	return f.m[name]
 }
 
+// concernContext holds the execution context for processing a single concern.
+// It bundles frequently-used parameters to reduce function signatures.
+type concernContext struct {
+	repoDir     string
+	concernName string
+	startedAt   string
+	head        string
+	lastSeen    string
+	pid         int
+}
+
+// fail writes a failed status and returns a wrapped error.
+func (ctx *concernContext) fail(origErr error, wrappedErr error) error {
+	return processConcernFailed(ctx.repoDir, ctx.concernName, ctx.startedAt,
+		ctx.head, ctx.lastSeen, ctx.pid, origErr, wrappedErr)
+}
+
 func processConcern(cfg *config.Config, repo *gitops.Repo, repoDir string, concern config.Concern, logMgr *LogManager) error {
 	pid := os.Getpid()
 	watchedBranch := ResolveWatchedBranch(cfg, concern)
@@ -189,14 +207,23 @@ func processConcern(cfg *config.Config, repo *gitops.Repo, repoDir string, conce
 		return nil
 	}
 
+	// Create execution context to reduce parameter passing
+	ctx := &concernContext{
+		repoDir:     repoDir,
+		concernName: concern.Name,
+		startedAt:   nowRFC3339(),
+		head:        head,
+		lastSeen:    lastSeen,
+		pid:         pid,
+	}
+
 	// Write change-detected status
-	startedAt := nowRFC3339()
-	_ = WriteStatus(repoDir, concern.Name, &ConcernStatus{
+	_ = WriteStatus(ctx.repoDir, ctx.concernName, &ConcernStatus{
 		State:       StateChangeDetected,
-		StartedAt:   startedAt,
-		HeadAtStart: head,
-		LastSeen:    lastSeen,
-		PID:         pid,
+		StartedAt:   ctx.startedAt,
+		HeadAtStart: ctx.head,
+		LastSeen:    ctx.lastSeen,
+		PID:         ctx.pid,
 	})
 
 	outputBranch := cfg.Settings.BranchPrefix + concern.Name
@@ -204,81 +231,72 @@ func processConcern(cfg *config.Config, repo *gitops.Repo, repoDir string, conce
 	// Ensure output branch exists
 	if !repo.BranchExists(outputBranch) {
 		if err := repo.CreateBranch(outputBranch, watchedBranch); err != nil {
-			return processConcernFailed(repoDir, concern.Name, startedAt, head, lastSeen, pid, err,
-				fmt.Errorf("creating output branch %s: %w", outputBranch, err))
+			return ctx.fail(err, fmt.Errorf("creating output branch %s: %w", outputBranch, err))
 		}
 	}
 
 	// Ensure worktree exists
 	wtPath := gitops.WorktreePath(repoDir, cfg.Settings.BranchPrefix, concern.Name)
 	if _, err := os.Stat(wtPath); os.IsNotExist(err) {
-		if err := os.MkdirAll(filepath.Dir(wtPath), 0755); err != nil {
-			return processConcernFailed(repoDir, concern.Name, startedAt, head, lastSeen, pid, err,
-				fmt.Errorf("creating worktree directory: %w", err))
+		if err := fileutil.EnsureDir(filepath.Dir(wtPath)); err != nil {
+			return ctx.fail(err, fmt.Errorf("creating worktree directory: %w", err))
 		}
 		if err := repo.CreateWorktree(wtPath, outputBranch); err != nil {
-			return processConcernFailed(repoDir, concern.Name, startedAt, head, lastSeen, pid, err,
-				fmt.Errorf("creating worktree: %w", err))
+			return ctx.fail(err, fmt.Errorf("creating worktree: %w", err))
 		}
 	}
 
 	// Rebase output branch onto watched branch so prior concern
 	// commits sit on top of the latest upstream state.
 	if err := rebaseWorktree(wtPath, watchedBranch); err != nil {
-		return processConcernFailed(repoDir, concern.Name, startedAt, head, lastSeen, pid, err,
-			fmt.Errorf("rebasing %s onto %s: %w", outputBranch, watchedBranch, err))
+		return ctx.fail(err, fmt.Errorf("rebasing %s onto %s: %w", outputBranch, watchedBranch, err))
 	}
 
 	// Assemble context
 	context, err := assembleContext(repo, cfg, concern, lastSeen, head)
 	if err != nil {
-		return processConcernFailed(repoDir, concern.Name, startedAt, head, lastSeen, pid, err,
-			fmt.Errorf("assembling context: %w", err))
+		return ctx.fail(err, fmt.Errorf("assembling context: %w", err))
 	}
 
 	// Get log file for this concern
 	logFile, err := logMgr.getLogFile(concern.Name)
 	if err != nil {
-		return processConcernFailed(repoDir, concern.Name, startedAt, head, lastSeen, pid, err,
-			fmt.Errorf("getting log file: %w", err))
+		return ctx.fail(err, fmt.Errorf("getting log file: %w", err))
 	}
 
 	// Write commit context header to log file
 	header := fmt.Sprintf("--- Processing %s at %s ---\n", head, time.Now().UTC().Format(time.RFC3339))
 	if _, err := logFile.WriteString(header); err != nil {
-		return processConcernFailed(repoDir, concern.Name, startedAt, head, lastSeen, pid, err,
-			fmt.Errorf("writing log header: %w", err))
+		return ctx.fail(err, fmt.Errorf("writing log header: %w", err))
 	}
 
 	// Write agent-started status
-	_ = WriteStatus(repoDir, concern.Name, &ConcernStatus{
+	_ = WriteStatus(ctx.repoDir, ctx.concernName, &ConcernStatus{
 		State:       StateAgentRunning,
-		StartedAt:   startedAt,
-		HeadAtStart: head,
-		LastSeen:    lastSeen,
-		PID:         pid,
+		StartedAt:   ctx.startedAt,
+		HeadAtStart: ctx.head,
+		LastSeen:    ctx.lastSeen,
+		PID:         ctx.pid,
 	})
 
 	// Invoke agent in worktree
 	if err := invokeAgent(cfg, wtPath, context, logFile); err != nil {
-		return processConcernFailed(repoDir, concern.Name, startedAt, head, lastSeen, pid, err,
-			fmt.Errorf("invoking agent: %w", err))
+		return ctx.fail(err, fmt.Errorf("invoking agent: %w", err))
 	}
 
 	// Write agent-succeeded status
-	_ = WriteStatus(repoDir, concern.Name, &ConcernStatus{
+	_ = WriteStatus(ctx.repoDir, ctx.concernName, &ConcernStatus{
 		State:       StateCommitting,
-		StartedAt:   startedAt,
-		HeadAtStart: head,
-		LastSeen:    lastSeen,
-		PID:         pid,
+		StartedAt:   ctx.startedAt,
+		HeadAtStart:  ctx.head,
+		LastSeen:    ctx.lastSeen,
+		PID:         ctx.pid,
 	})
 
 	// Check for changes and commit
 	changed, err := commitChanges(wtPath, concern, head)
 	if err != nil {
-		return processConcernFailed(repoDir, concern.Name, startedAt, head, lastSeen, pid, err,
-			fmt.Errorf("committing changes: %w", err))
+		return ctx.fail(err, fmt.Errorf("committing changes: %w", err))
 	}
 
 	if !changed {
@@ -292,8 +310,7 @@ func processConcern(cfg *config.Config, repo *gitops.Repo, repoDir string, conce
 
 	// Update last-seen
 	if err := SetLastSeen(repoDir, concern.Name, head); err != nil {
-		return processConcernFailed(repoDir, concern.Name, startedAt, head, lastSeen, pid, err,
-			fmt.Errorf("updating last-seen marker: %w", err))
+		return ctx.fail(err, fmt.Errorf("updating last-seen marker: %w", err))
 	}
 
 	// Write idle status with result
@@ -301,14 +318,14 @@ func processConcern(cfg *config.Config, repo *gitops.Repo, repoDir string, conce
 	if changed {
 		result = ResultModified
 	}
-	_ = WriteStatus(repoDir, concern.Name, &ConcernStatus{
+	_ = WriteStatus(ctx.repoDir, ctx.concernName, &ConcernStatus{
 		State:       StateIdle,
 		LastResult:  result,
-		StartedAt:   startedAt,
+		StartedAt:   ctx.startedAt,
 		CompletedAt: nowRFC3339(),
-		LastSeen:    head,
-		HeadAtStart: head,
-		PID:         pid,
+		LastSeen:    ctx.head,
+		HeadAtStart: ctx.head,
+		PID:         ctx.pid,
 	})
 
 	return nil
@@ -373,6 +390,21 @@ func ResolveWatchedBranch(cfg *config.Config, concern config.Concern) string {
 	return concern.Watches
 }
 
+// forEachCommitMessage iterates over commits and calls fn with each commit hash and message.
+// Returns early with error if CommitMessage fails.
+func forEachCommitMessage(repo *gitops.Repo, commits []string, fn func(hash, msg string) error) error {
+	for _, hash := range commits {
+		msg, err := repo.CommitMessage(hash)
+		if err != nil {
+			return err
+		}
+		if err := fn(hash, msg); err != nil {
+			return err
+		}
+	}
+	return nil
+}
+
 func assembleContext(repo *gitops.Repo, cfg *config.Config, concern config.Concern, lastSeen, head string) (string, error) {
 	commits, err := repo.CommitsBetween(lastSeen, head)
 	if err != nil {
@@ -390,13 +422,9 @@ func assembleContext(repo *gitops.Repo, cfg *config.Config, concern config.Conce
 	sb.WriteString(concern.Prompt + "\n\n")
 	sb.WriteString("## New commits to review\n\n")
 
-	for _, hash := range commits {
-		msg, err := repo.CommitMessage(hash)
-		if err != nil {
-			return "", err
-		}
+	err = forEachCommitMessage(repo, commits, func(hash, msg string) error {
 		if skipAgent && isAgentCommit(msg) {
-			continue
+			return nil
 		}
 		sb.WriteString("### Commit " + hash[:8] + "\n")
 		sb.WriteString("Message: " + msg + "\n\n")
@@ -406,6 +434,10 @@ func assembleContext(repo *gitops.Repo, cfg *config.Config, concern config.Conce
 		if err == nil && diff != "" {
 			sb.WriteString("```diff\n" + diff + "\n```\n\n")
 		}
+		return nil
+	})
+	if err != nil {
+		return "", err
 	}
 
 	return sb.String(), nil
@@ -471,7 +503,7 @@ func invokeAgent(cfg *config.Config, worktreeDir, context string, output io.Writ
 // with the configured permissions, so Claude Code agents get pre-approved tools.
 func writePermissions(worktreeDir string, perms *config.Permissions) error {
 	claudeDir := filepath.Join(worktreeDir, ".claude")
-	if err := os.MkdirAll(claudeDir, 0755); err != nil {
+	if err := fileutil.EnsureDir(claudeDir); err != nil {
 		return err
 	}
 
@@ -527,20 +559,18 @@ func allCommitsSkipped(repo *gitops.Repo, lastSeen, head string, skipAgentCommit
 	if err != nil || len(commits) == 0 {
 		return false
 	}
-	for _, hash := range commits {
-		msg, err := repo.CommitMessage(hash)
-		if err != nil {
-			return false
-		}
+	allSkipped := true
+	err = forEachCommitMessage(repo, commits, func(hash, msg string) error {
 		if hasSkipMarker(msg) {
-			continue
+			return nil
 		}
 		if skipAgentCommits && isAgentCommit(msg) {
-			continue
+			return nil
 		}
-		return false
-	}
-	return true
+		allSkipped = false
+		return nil
+	})
+	return err == nil && allSkipped
 }
 
 // hasSkipMarker checks if a commit message contains a recognized skip marker.
diff --git a/internal/engine/state.go b/internal/engine/state.go
index 935a880..2d02cb7 100644
--- a/internal/engine/state.go
+++ b/internal/engine/state.go
@@ -8,6 +8,8 @@ import (
 	"strings"
 	"syscall"
 	"time"
+
+	"github.com/re-cinq/detergent/internal/fileutil"
 )
 
 // State constants
@@ -26,9 +28,14 @@ const (
 	ResultModified = "modified"
 )
 
+// detergentSubdir builds a path to a subdirectory within .detergent.
+func detergentSubdir(repoDir, subdir string) string {
+	return filepath.Join(repoDir, ".detergent", subdir)
+}
+
 // stateDir returns the state directory path for a repo.
 func stateDir(repoDir string) string {
-	return filepath.Join(repoDir, ".detergent", "state")
+	return detergentSubdir(repoDir, "state")
 }
 
 // LastSeen returns the last-seen commit hash for a concern, or "" if none.
@@ -58,13 +65,13 @@ type ConcernStatus struct {
 
 // statusDir returns the status directory path for a repo.
 func statusDir(repoDir string) string {
-	return filepath.Join(repoDir, ".detergent", "status")
+	return detergentSubdir(repoDir, "status")
 }
 
 // WriteStatus writes a concern's status to its JSON status file.
 func WriteStatus(repoDir, concernName string, status *ConcernStatus) error {
 	dir := statusDir(repoDir)
-	if err := os.MkdirAll(dir, 0755); err != nil {
+	if err := fileutil.EnsureDir(dir); err != nil {
 		return err
 	}
 	data, err := json.Marshal(status)
@@ -121,7 +128,7 @@ func IsProcessAlive(pid int) bool {
 // SetLastSeen records the last-seen commit hash for a concern.
 func SetLastSeen(repoDir, concernName, hash string) error {
 	dir := stateDir(repoDir)
-	if err := os.MkdirAll(dir, 0755); err != nil {
+	if err := fileutil.EnsureDir(dir); err != nil {
 		return err
 	}
 	return os.WriteFile(filepath.Join(dir, concernName), []byte(hash+"\n"), 0644)
diff --git a/internal/fileutil/fileutil.go b/internal/fileutil/fileutil.go
new file mode 100644
index 0000000..ce182a2
--- /dev/null
+++ b/internal/fileutil/fileutil.go
@@ -0,0 +1,8 @@
+package fileutil
+
+import "os"
+
+// EnsureDir creates a directory and all parent directories with 0755 permissions.
+func EnsureDir(path string) error {
+	return os.MkdirAll(path, 0755)
+}
```

